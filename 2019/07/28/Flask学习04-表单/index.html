<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/assets/avatar_16x16.jpg?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/assets/avatar_32x32.jpg?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="HTML 表单       12345678910&lt;form method&#x3D;&quot;post&quot;&gt;    &lt;label for&#x3D;&quot;username&quot;&gt;Username&lt;&#x2F;label&gt;&lt;br &#x2F;&gt;    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;usern">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask学习04-表单">
<meta property="og:url" content="https://blog.zyuanlee.cn/2019/07/28/Flask%E5%AD%A6%E4%B9%A004-%E8%A1%A8%E5%8D%95/index.html">
<meta property="og:site_name" content="Pandalzy&#39;s Blog">
<meta property="og:description" content="HTML 表单       12345678910&lt;form method&#x3D;&quot;post&quot;&gt;    &lt;label for&#x3D;&quot;username&quot;&gt;Username&lt;&#x2F;label&gt;&lt;br &#x2F;&gt;    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;usern">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-07-28T10:44:34.000Z">
<meta property="article:modified_time" content="2021-06-27T00:34:28.398Z">
<meta property="article:author" content="Pandalzy">
<meta property="article:tag" content="Python3">
<meta property="article:tag" content="Flask学习">
<meta name="twitter:card" content="summary"><title>Flask学习04-表单 | Pandalzy's Blog</title><link ref="canonical" href="https://blog.zyuanlee.cn/2019/07/28/Flask%E5%AD%A6%E4%B9%A004-%E8%A1%A8%E5%8D%95/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-address-card"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-user-friends"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Pandalzy's Blog</div><div class="header-banner-info__subtitle">Stay hungry, stay foolish.</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Flask学习04-表单</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-07-28</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-06-27</span></span></div></header><div class="post-body">
        <h2 id="HTML-表单"   >
          <a href="#HTML-表单" class="heading-link"><i class="fas fa-link"></i></a>HTML 表单</h2>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;用户名&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;密码&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;remember&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">checked</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;remember&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">small</span>&gt;</span>Remember me<span class="tag">&lt;/<span class="name">small</span>&gt;</span>&lt;/label</span><br><span class="line">    &gt;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Log in&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<span id="more"></span>


        <h2 id="使用-Flask-WTF-处理表单"   >
          <a href="#使用-Flask-WTF-处理表单" class="heading-link"><i class="fas fa-link"></i></a>使用 Flask-WTF 处理表单</h2>
      <ul>
<li>安装<strong>Flask-WTF</strong>及其依赖</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv install flask-wtf</span><br></pre></td></tr></table></div></figure>

<ul>
<li>Flask-WTF<strong>默认为每个表单启用 CSRF 保护，它自动生成和验证 CSRF 令牌</strong>。默认情况下，<strong>Flask-WTF</strong>使用程序密钥来对<strong>CSRF 令牌</strong>进行签名，所以我们需要为程序设置密钥：</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.secret_key = &#x27;secret string&#x27;</span><br></pre></td></tr></table></div></figure>


        <h3 id="定义-WTForms-表单类"   >
          <a href="#定义-WTForms-表单类" class="heading-link"><i class="fas fa-link"></i></a>定义 WTForms 表单类</h3>
      <ul>
<li>当使用<strong>WTForms</strong>创建表单时，表单由 Python 类表示，这个类继承从<strong>WTForms</strong>导入的 Form 基类。一个表单由若干个输入字段组成，这些字段分别用表单类的类属性来表示（字段即 Field，可以简单理解为表单内的输入框、按钮等部件）。下面定义了一个<strong>LoginForm</strong>类，最终会生成在前面定义的 HTML 表单：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form, StringField, PasswordField, BooleanField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Length</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>)])</span><br><span class="line">    remember = BooleanField(<span class="string">&#x27;Remember me&#x27;</span>)</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Log in&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>每个字段属性通过实例化 WTForms 提供的字段类表示。字段属性的名称将作为对应 HTML<code>&lt;input&gt;</code>元素的 name 属性及 id 属性值。</p>
</li>
<li><p>常用的 WTForms 字段</p>
</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>字段类</th>
<th>说明</th>
<th>对应的 html</th>
</tr>
</thead>
<tbody><tr>
<td>BooleanField</td>
<td>复选框，值会被处理为 True 或 False</td>
<td><code>&lt;input type=&quot;checkbox&quot;&gt;</code></td>
</tr>
<tr>
<td>DateField</td>
<td>文本字段，值会被处理为 datetime.date 对象</td>
<td><code>&lt;input type=&quot;text&quot;&gt;</code></td>
</tr>
<tr>
<td>DateTimeField</td>
<td>文本字段，值会被处理为 datetime.datetime 对象</td>
<td><code>&lt;input type=&quot;text&quot;&gt;</code></td>
</tr>
<tr>
<td>FileField</td>
<td>文件上传字段</td>
<td><code>&lt;input type=file&quot;&quot;&gt;</code></td>
</tr>
<tr>
<td>FloatField</td>
<td>浮点数字段，值会被处理为浮点型</td>
<td><code>&lt;input type=&quot;text&quot;&gt;</code></td>
</tr>
<tr>
<td>IntegerField</td>
<td>整数字段，值会被处理为整型</td>
<td><code>&lt;input type=&quot;text&quot;&gt;</code></td>
</tr>
<tr>
<td>RadioField</td>
<td>一组单选按钮</td>
<td><code>&lt;input type=&quot;radio&quot;&gt;</code></td>
</tr>
<tr>
<td>SelectField</td>
<td>下拉列表</td>
<td><code>&lt;select&gt;&lt;option&gt;&lt;/option&gt;&lt;/select&gt;</code></td>
</tr>
<tr>
<td>SelectMultipleField</td>
<td>多选下拉列表</td>
<td><code>&lt;select multiple&gt;&lt;option&gt;&lt;/option&gt;&lt;/select&gt;</code></td>
</tr>
<tr>
<td>SubmitField</td>
<td>提交按钮</td>
<td><code>&lt;input type=&quot;submit&quot;&gt;</code></td>
</tr>
<tr>
<td>StringField</td>
<td>文本字段</td>
<td><code>&lt;input type=&quot;text&quot;&gt;</code></td>
</tr>
<tr>
<td>HiddenField</td>
<td>隐藏文本字段</td>
<td><code>&lt;input type=&quot;hidden&quot;&gt;</code></td>
</tr>
<tr>
<td>PasswordField</td>
<td>密码文本字段</td>
<td><code>&lt;input type=&quot;password&quot;&gt;</code></td>
</tr>
<tr>
<td>TextAreaField</td>
<td>多行文本字段</td>
<td><code>&lt;textarea&gt;&lt;/textarea&gt;</code></td>
</tr>
</tbody></table></div>
<ul>
<li>通过实例化字段类时传入的参数，可以对字段进行设置，实例化字段类常用参数：</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>label</td>
<td>字段标签<code>&lt;label&gt;</code>的值，也就是渲染后显示在输入字段前的文字</td>
</tr>
<tr>
<td>render_kw</td>
<td>一个字典，用来设置对应的 HTML<code>&lt;input&gt;</code>标签的属性，比如传入{‘placeholder’: ‘Name’}</td>
</tr>
<tr>
<td>validators</td>
<td>一个列表，包含一系列验证器，会在表单提交后被逐一调用验证表单数据</td>
</tr>
<tr>
<td>default</td>
<td>字符串或可调用对象，用来为表单字段设置默认值</td>
</tr>
</tbody></table></div>
<ul>
<li>在 WTForms 中，验证器（validator）是一系列用于验证字段数据的类，在实例化字段类时使用<strong>validators</strong>关键字来指定附加的验证器列表。验证器从<strong>wtforms.validators</strong>模块中导入，常用的验证器：</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>验证器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DataRequired(message=None)</td>
<td>验证数据是否有效</td>
</tr>
<tr>
<td>Email(message=None)</td>
<td>验证 Email 地址</td>
</tr>
<tr>
<td>EqualTo(message=None)</td>
<td>验证两个字段的值是否相同</td>
</tr>
<tr>
<td>InputRequired(message=None)</td>
<td>验证是否有数据</td>
</tr>
<tr>
<td>Length(min=-1, max=-1, message=None)</td>
<td>验证输入值长度是否在给定的范围内</td>
</tr>
<tr>
<td>NumberRange(min=None, max=None, message=None)</td>
<td>验证输入数字是否在给定的范围内</td>
</tr>
<tr>
<td>Optional(strip_whitespace=True)</td>
<td>允许输入值为空，并跳过其他验证</td>
</tr>
<tr>
<td>Regexp(regex, flags=0, message=None)</td>
<td>使用正则表达式验证输入值</td>
</tr>
<tr>
<td>URL(require_tld=True, message=None)</td>
<td>验证 URL</td>
</tr>
<tr>
<td>AnyOf(values, message=None, values_formatter=None)</td>
<td>确保输入值在可选值列表中</td>
</tr>
<tr>
<td>NoneOf(values, message=None, values_formatter=None)</td>
<td>确保输入值不在可选值列表中</td>
</tr>
</tbody></table></div>
<ul>
<li>在 name 和 password 字段里，都使用了<strong>DataRequired</strong>验证器，用来验证输入的数据是否有效。另外，password 字段里还添加了一个<strong>Length</strong>验证器，用来验证输入的数据长度是否在给定的范围内。验证器的第一个参数一般为错误提示消息，可以使用<strong>message</strong>关键字传递参数，通过传入自定义错误信息来覆盖内置消息，比如：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">name = StringField(<span class="string">&#x27;Your Name&#x27;</span>, validators=[DataRequired(message=<span class="string">u&#x27;名字不能为空！&#x27;</span>)])</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>Flask-WTF 定义表单时，仍然使用 WTForms 提供的字段类和验证器，创建的方式也完全相同，只不过表单类要继承 Flask-WTF 提供的 FlaskForm 类。FlaskForm 类继承自 Form 类，进行了一些设置，并附加了一些辅助方法，以便与 Flask 集成。</p>
</li>
<li><p>定义表单类</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, PasswordField, BooleanField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Length</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>)])</span><br><span class="line">    remember = BooleanField(<span class="string">&#x27;Remember me&#x27;</span>)</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Log in&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>配置键<strong>WTF_CSRF_ENABLED</strong>用来设置是否开启 CSRF 保护，默认为 True。Flask-WTF 会自动在实例化表单类时添加一个包含 CSRF 令牌值的隐藏字段，字段名为<strong>csrf_token</strong>。</p>
</blockquote>

        <h3 id="输出-HTMl-代码"   >
          <a href="#输出-HTMl-代码" class="heading-link"><i class="fas fa-link"></i></a>输出 HTMl 代码</h3>
      <ul>
<li>以 WTForms 创建的 LoginForm 为例，实例化表单类，然后将实例属性转换成字符串或直接调用就可以获取表单字段对应的 HTML 代码：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>form = LoginForm()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.username()</span><br><span class="line"><span class="string">&#x27;&lt;input id=&quot;username&quot; name=&quot;username&quot; required type=&quot;text&quot; value=&quot;&quot;&gt;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.submit()</span><br><span class="line"><span class="string">&#x27;&lt;input id=&quot;submit&quot; name=&quot;submit&quot; type=&quot;submit&quot; value=&quot;Log in&quot;&gt;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>字段的<code>&lt;label&gt;</code>元素的 HTML 代码则可以通过<strong>form.字段名.label</strong>的形式获取：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.username.label()</span><br><span class="line"><span class="string">&#x27;&lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>默认情况下，WTForms 输出的字段 HTML 代码只会包含 id 和 name 属性，属性值均为表单类中对应的字段属性名称。如果要添加额外的属性，通常有两种方法。</li>
</ul>

        <h4 id="使用-render-kw-属性"   >
          <a href="#使用-render-kw-属性" class="heading-link"><i class="fas fa-link"></i></a>使用 render_kw 属性</h4>
      <ul>
<li>比如下面为 username 字段使用 render_kw 设置了 placeholder HTML 属性：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username = StringField(<span class="string">&#x27;Username&#x27;</span>, render_kw=&#123;<span class="string">&#x27;placeholder&#x27;</span>: <span class="string">&#x27;Your Username&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># &lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;Your Username&quot;&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="在调用字段时传入"   >
          <a href="#在调用字段时传入" class="heading-link"><i class="fas fa-link"></i></a>在调用字段时传入</h4>
      <ul>
<li>在调用字段属性时，通过添加括号使用关键字参数的形式也可以传入字段额外的 HTML 属性：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.username(style=<span class="string">&#x27;width: 200px;&#x27;</span>, class_=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&lt;i nput class=&quot;bar&quot; id=&quot;username&quot; name=&quot;username&quot; style=&quot;width: 200px;&quot; type=&quot;text&quot;&gt;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>class 是 Python 的保留关键字，在这里使用<strong>class_</strong>来代替 class，渲染后的<code>&lt;input&gt;</code>会获得正确的 class 属性，在模板中调用时则可以直接使用 class。</p>
</blockquote>

        <h3 id="在模板中渲染表单"   >
          <a href="#在模板中渲染表单" class="heading-link"><i class="fas fa-link"></i></a>在模板中渲染表单</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> forms <span class="keyword">import</span> LoginForm</span><br><span class="line"><span class="comment"># 引入bootstrap</span></span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">app.secret_key = <span class="string">&#x27;secret string&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Hello Flask!&lt;/h1&gt;&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/basic&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic</span>():</span></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123;bootstrap_find_resource(&#x27;css/bootstrap.css&#x27;, cdn=&#x27;bootstrap&#x27;)&#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.csrf_token &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.username.label &#125;&#125; &#123;&#123; form.username(class=&#x27;form-control&#x27;) &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.password.label &#125;&#125; &#123;&#123; form.password(class=&#x27;form-control&#x27;) &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-check&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.remember(class=&#x27;form-check-input&#x27;) &#125;&#125; &#123;&#123; form.remember.label &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.submit(class=&#x27;btn btn-primary&#x27;) &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;bootstrap_find_resource(&#x27;jquery.js&#x27;, cdn=&#x27;jquery&#x27;)&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;bootstrap_find_resource(&#x27;js/bootstrap.js&#x27;, cdn=&#x27;bootstrap&#x27;)&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>渲染后获得的实际 HTML 代码如下所示：</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Ijc3ZDI5Y...&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 渲染CSRF令牌隐藏字段 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">required</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">required</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;remember&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">value</span>=<span class="string">&quot;y&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;remember&quot;</span>&gt;</span>Remember me<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Log in&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="处理表单数据"   >
          <a href="#处理表单数据" class="heading-link"><i class="fas fa-link"></i></a>处理表单数据</h2>
      
        <h3 id="提交表单"   >
          <a href="#提交表单" class="heading-link"><i class="fas fa-link"></i></a>提交表单</h3>
      <ul>
<li>在 HTML 中，当<code>&lt;form&gt;</code>标签声明的表单中类型为<strong>submit</strong>的提交字段被单击时，就会创建一个提交表单的 HTTP 请求，请求中包含表单各个字段的数据。表单的提交行为主要由三个属性控制</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>action</td>
<td>当前 URL，即页面对应的 URL</td>
<td>表单提交时发送请求的目标 URL</td>
</tr>
<tr>
<td>method</td>
<td>get</td>
<td>提交表单的 HTTP 请求方法，get 或者 post</td>
</tr>
<tr>
<td>enctype</td>
<td>application/x-www-form-urlencoded</td>
<td>表单数据的编码类型</td>
</tr>
</tbody></table></div>
<ul>
<li><p>form 标签的 action 属性用来指定表单被提交的目标 URL，默认为当前 URL，也就是渲染该模板的路由所在的 URL。如果要把表单数据发送到其他 URL，可以自定义这个属性值。</p>
</li>
<li><p>当使用 GET 方法提交表单数据时，表单的数据会以查询字符串的形式附加在请求的 URL 里，比如：</p>
</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5000/basic?username=greyli&amp;password=12345</span><br></pre></td></tr></table></div></figure>

<ul>
<li>GET 方式仅适用于长度不超过 3000 个字符，且不包含敏感信息的表单。因为这种方式会直接将用户提交的表单数据暴露在 URL 中，容易被攻击者截获，示例中的情况明显是危险的。因此，出于安全的考虑，一般使用 POST 方法提交表单。使用 POST 方法时，按照默认的编码类型，表单数据会被存储在请求主体中，比如：</li>
</ul>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;basic HTTP&#x2F;1.0</span><br><span class="line">...</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 30</span><br><span class="line"></span><br><span class="line">username&#x3D;greyli&amp;password&#x3D;12345</span><br></pre></td></tr></table></div></figure>

<ul>
<li>设置监听 POST 方法</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic</span>():</span></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;basic.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>


        <h3 id="验证表单数据"   >
          <a href="#验证表单数据" class="heading-link"><i class="fas fa-link"></i></a>验证表单数据</h3>
      
        <h4 id="客户端验证和服务器端验证"   >
          <a href="#客户端验证和服务器端验证" class="heading-link"><i class="fas fa-link"></i></a>客户端验证和服务器端验证</h4>
      <ul>
<li>客户端验证</li>
<li>客户端验证（client side validation）是指在客户端（比如 Web 浏览器）对用户的输入值进行验证。客户端方式可以实时动态提示用户输入是否正确，只有用户输入正确后才会将表单数据发送到服务器。客户端验证可以增强用户体验，降低服务器负载。</li>
<li>服务器端验证</li>
<li>服务器端验证（server side validation）是指用户把输入的数据提交到服务器端，在服务器端对数据进行验证。如果验证出错，就在返回的响应中加入错误信息。用户修改后再次提交表单，直到通过验证。在 Flask 程序中使用 WTForms 实现的就是服务器端验证。</li>
</ul>

        <h4 id="WTForms-验证机制"   >
          <a href="#WTForms-验证机制" class="heading-link"><i class="fas fa-link"></i></a>WTForms 验证机制</h4>
      <ul>
<li>WTForms 验证表单字段的方式是在实例化表单类时传入表单数据，然后对表单实例调用<strong>validate()**方法。这会逐个对字段调用字段实例化时定义的验证器，返回表示验证结果的布尔值。如果验证失败，就把错误消息存储到表单实例的</strong>errors**属性对应的字典中，验证的过程如下所示：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form, StringField, PasswordField, BooleanField</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Length</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">Form</span>):</span></span><br><span class="line"><span class="meta">... </span>    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired()])</span><br><span class="line"><span class="meta">... </span>    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>)])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form = LoginForm(username=<span class="string">&#x27;&#x27;</span>, password=<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.data  <span class="comment"># 表单数据字典</span></span><br><span class="line">&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.validate()</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form.errors  <span class="comment"># 错误消息字典</span></span><br><span class="line">&#123;<span class="string">&#x27;username&#x27;</span>: [<span class="string">u&#x27;This field is required.&#x27;</span>], <span class="string">&#x27;password&#x27;</span>: [<span class="string">u&#x27;Field must be at least 6 characters long.&#x27;</span>]&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form2 = LoginForm(username=<span class="string">&#x27;greyli&#x27;</span>, password=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form2.data</span><br><span class="line">&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;greyli&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form2.validate()</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>form2.errors</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="在视图函数中验证表单"   >
          <a href="#在视图函数中验证表单" class="heading-link"><i class="fas fa-link"></i></a>在视图函数中验证表单</h4>
      <ul>
<li><p>因为现在的 basic_form 视图同时接收两种类型的请求：GET 请求和 POST 请求。所以要根据请求方法的不同执行不同的代码。</p>
</li>
<li><p>具体来说：首先是实例化表单，如果是 GET 请求，那么就渲染模板；如果是 POST 请求，就调用 validate()方法验证表单数据。</p>
</li>
<li><p>请求的 HTTP 方法可以通过<strong>request.method</strong>属性获取，可以使用下面的方式来组织视图函数：</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/basic&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic</span>():</span></span><br><span class="line">    form = LoginForm()  <span class="comment"># GET + POST</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> form.validate():</span><br><span class="line">        <span class="comment"># ...  # 处理POST请求</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;forms/basic.html&#x27;</span>, form=form)  <span class="comment"># 处理GET请求</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>Flask-WTF 提供的**validate_on_submit()**方法合并了这两个操作，因此上面的代码可以简化为：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/basic&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic</span>():</span></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;basic.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>除了 POST 方法，如果请求的方法是 PUT、PATCH 和 DELETE 方法，**form.validate_on_submit()**也会验证表单数据。</p>
</blockquote>

        <h4 id="表单验证与获取数据"   >
          <a href="#表单验证与获取数据" class="heading-link"><i class="fas fa-link"></i></a>表单验证与获取数据</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, url_for, flash</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/basic&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic</span>():</span></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        username = form.username.data</span><br><span class="line">        flash(<span class="string">&#x27;Welcome home, %s!&#x27;</span> % username)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;basic.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>表单类的 data 属性是一个匹配所有字段与对应数据的字典，我们一般直接通过<strong>“form.字段属性名.data”</strong>的形式来获取对应字段的数据。</p>
</li>
<li><p>在这个 if 语句内，如果不使用重定向的话，当 if 语句执行完毕后会继续执行最后的**render_template()**函数渲染模板，最后像往常一样返回一个常规的 200 响应，但这会造成一个问题：</p>
<ul>
<li>在浏览器中，当单击 F5 刷新/重载时的默认行为是发送上一个请求。如果上一个请求是 POST 请求，那么就会弹出一个确认窗口，询问用户是否再次提交表单。为了避免出现这个容易让人产生困惑的提示，尽量不要让提交表单的 POST 请求作为最后一个请求。这就是为什么在处理表单后返回一个重定向响应，这会让浏览器重新发送一个新的 GET 请求到重定向的目标 URL。最终，最后一个请求就变成了 GET 请求。这种用来防止重复提交表单的技术称为 PRG（Post/Redirect/Get）模式，即通过对提交表单的 POST 请求返回重定向响应将最后一个请求转换为 GET 请求。</li>
</ul>
</li>
</ul>

        <h3 id="在模板中渲染错误消息"   >
          <a href="#在模板中渲染错误消息" class="heading-link"><i class="fas fa-link"></i></a>在模板中渲染错误消息</h3>
      <ul>
<li><p>如果<strong>form.validate_on_submit()**返回 False，那么说明验证没有通过。对于验证未通过的字段，WTForms 会把错误消息添加到表单类的</strong>errors<strong>属性中，这是一个匹配作为表单字段的类属性到对应的错误消息列表的字典。一般会直接通过字段名来获取对应字段的错误消息列表，即</strong>form.字段名.errors<strong>。比如，</strong>form.name.errors**返回 name 字段的错误消息列表。</p>
</li>
<li><p>像渲染 flash()消息一样，可以在模板里使用 for 循环迭代错误消息列表</p>
</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.csrf_token &#125;&#125; &#123;&#123; form.username.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;&#123; form.username() &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;% for message in form.username.errors %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">small</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;% endfor %&#125; &#123;&#123; form.password.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;&#123; form.password &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;% for message in form.password.errors %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">small</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;% endfor %&#125; &#123;&#123; form.remember &#125;&#125;&#123;&#123; form.remember.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;&#123; form.submit &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="表单进阶实践"   >
          <a href="#表单进阶实践" class="heading-link"><i class="fas fa-link"></i></a>表单进阶实践</h2>
      
        <h3 id="设置错误消息语言"   >
          <a href="#设置错误消息语言" class="heading-link"><i class="fas fa-link"></i></a>设置错误消息语言</h3>
      <ul>
<li>设置内置错误消息语言为中文</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;WTF_I18N_ENABLED&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBaseForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        location = [<span class="string">&#x27;zh&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloForm</span>(<span class="params">MyBaseForm</span>):</span></span><br><span class="line">    name = StringField(<span class="string">&#x27;Name&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></div></figure>

<ul>
<li>首先，需要将配置变量<strong>WTF_I18N_ENABLED</strong>设为 False，这会让 Flask-WTF 使用 WTForms 内置的错误消息翻译。然后需要在自定义基类中定义 Meta 类，并在 locales 列表中加入简体中文的地区字符串。在创建表单时，继承这个 MyBaseForm 即可将错误消息语言设为中文，比如上面定义的 HelloForm。</li>
</ul>

        <h3 id="使用宏渲染表单"   >
          <a href="#使用宏渲染表单" class="heading-link"><i class="fas fa-link"></i></a>使用宏渲染表单</h3>
      <ul>
<li>表单渲染宏</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro form_field(field) %&#125; &#123;&#123; field.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">&#123;&#123; field(**kwargs) &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">&#123;% if field.errors %&#125; &#123;% for error in field.errors %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;&#123; error &#125;&#125;<span class="tag">&lt;/<span class="name">small</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">&#123;% endfor %&#125; &#123;% endif %&#125; &#123;% endmacro %&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这个 form_field()宏接收表单类实例的字段属性和附加的关键字参数作为输入，返回包含<code>&lt;label&gt;</code>标签、表单字段、错误消息列表的 HTML 表单字段代码。使用这个宏渲染表单的示例如下所示：</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% from &#x27;macros.html&#x27; import form_field %&#125; ...</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.csrf_token &#125;&#125; &#123;&#123; form_field(form.username)&#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    &#123;&#123; form_field(form.password) &#125;&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>在上面的代码中，调用 form_field()宏逐个渲染表单中的字段，只要把每一个类属性传入 form_field()宏，即可完成渲染。</li>
</ul>

        <h3 id="自定义验证器"   >
          <a href="#自定义验证器" class="heading-link"><i class="fas fa-link"></i></a>自定义验证器</h3>
      
        <h4 id="行内验证器"   >
          <a href="#行内验证器" class="heading-link"><i class="fas fa-link"></i></a>行内验证器</h4>
      <ul>
<li>除了使用 WTForms 提供的验证器来验证表单字段，还可以在表单类中定义方法来验证特定字段</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 针对特定字段的验证器</span></span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> IntegerField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FortyTwoForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    answer = IntegerField(<span class="string">&#x27;The Number&#x27;</span>)</span><br><span class="line">    submit = SubmitField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_answer</span>(<span class="params">form, field</span>):</span></span><br><span class="line">        <span class="keyword">if</span> field.data != <span class="number">42</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;Must be 42.&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>当表单类中包含以“validate_字段属性名”形式命名的方法时，在验证字段数据时会同时调用这个方法来验证对应的字段，这也是为什么表单类的字段属性名不能以 validate 开头。验证方法接收两个位置参数，依次为 form 和 field，前者为表单类实例，后者是字段对象，可以通过 field.data 获取字段数据，这两个参数将在验证表单时被调用传入。验证出错时抛出从<strong>wtforms.validators</strong>模块导入的<strong>ValidationError</strong>异常，传入错误消息作为参数。因为这种方法仅用来验证特定的表单类字段，所以又称为行内验证器（in-line validator）。</li>
</ul>

        <h4 id="全局验证器"   >
          <a href="#全局验证器" class="heading-link"><i class="fas fa-link"></i></a>全局验证器</h4>
      <ul>
<li>如果想要创建一个可重用的通用验证器，可以通过定义一个函数实现。如果不需要传入参数定义验证器，那么一个和表单类中定义的验证方法完全相同的函数就足够了</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局验证器示例</span></span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_42</span>(<span class="params">form, field</span>):</span></span><br><span class="line">    <span class="keyword">if</span> field.data != <span class="number">42</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;Must be 42&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FortyTwoForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    answer = IntegerField(<span class="string">&#x27;The Number&#x27;</span>, validators=[is_42])</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>当使用函数定义全局的验证器时，需要在定义字段时在 validators 列表里传入这个验证器。因为在 validators 列表中传入的验证器必须是可调用对象，所以这里传入了函数对象，而不是函数调用。</p>
</li>
<li><p>这仅仅是一个简单的示例，在现实中，通常需要让验证器支持传入参数来对验证过程进行设置。至少，应该支持 message 参数来设置自定义错误消息。这时验证函数应该实现成工厂函数，即返回一个可调用对象的函数</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 工厂函数形式的全局验证器示例</span></span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_42</span>(<span class="params">message=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        message = <span class="string">&#x27;Must be 42.&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_42</span>(<span class="params">form, field</span>):</span></span><br><span class="line">        <span class="keyword">if</span> field.data != <span class="number">42</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _is_42</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FortyTwoForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    answer = IntegerField(<span class="string">&#x27;The Number&#x27;</span>, validators=[is_42()])</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在现在的 is_42()函数中，创建了另一个_is_42()函数，这个函数会被作为可调用对象返回。is_42()函数接收的 message 参数用来传入自定义错误消息，默认为 None，如果没有设置就使用内置消息。在 validators 列表中，这时需要传入的是对工厂函数 is_42()的调用。</li>
</ul>

        <h3 id="文件上传"   >
          <a href="#文件上传" class="heading-link"><i class="fas fa-link"></i></a>文件上传</h3>
      <ul>
<li>在 HTML 中，渲染一个文件上传字段只需要将<code>&lt;input&gt;</code>标签的 type 属性设为 file，即<code>&lt;input type=&quot;file&quot;&gt;</code>。这会在浏览器中渲染成一个文件上传字段，单击文件选择按钮会打开文件选择窗口，选择对应的文件后，被选择的文件名会显示在文件选择按钮旁边。</li>
</ul>

        <h4 id="定义上传表单"   >
          <a href="#定义上传表单" class="heading-link"><i class="fas fa-link"></i></a>定义上传表单</h4>
      <ul>
<li>在 Python 表单类中创建文件上传字段时，使用扩展 Flask-WTF 提供的 FileField 类，它继承 WTForms 提供的上传字段 FileField，添加了对 Flask 的集成。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建上传表单</span></span><br><span class="line"><span class="keyword">from</span> flask wtf.file <span class="keyword">import</span> FileField, FileRequired, FileAllowed</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    photo = FileField(<span class="string">&#x27;Upload Image&#x27;</span>, validators=[FileRequired(), FileAllowed([<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>])])</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></div></figure>

<ul>
<li>为了便于测试，创建一个用来上传图片的 photo 字段。和其他字段类似，也需要对文件上传字段进行验证。Flask-WTF 在<strong>flask_wtf.file</strong>模块下提供了两个文件相关的验证器</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>验证器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>FileRequired(message=None)</td>
<td>验证是否包含文件对象</td>
</tr>
<tr>
<td>FileAllowed(upload_set, message=None)</td>
<td>用来验证文件类型，upload_set 参数用来传入包含允许的文件后缀名列表</td>
</tr>
</tbody></table></div>
<ul>
<li><p>使用<strong>FileRequired</strong>确保提交的表单字段中包含文件数据。出于安全考虑，必须对上传的文件类型进行限制。如果用户可以上传 HTML 文件，而且同时提供了视图函数获取上传后的文件，那么很容易导致 XSS 攻击。使用 FileAllowed 设置允许的文件类型，传入一个包含允许文件类型的后缀名列表。</p>
</li>
<li><p>Flask-WTF 提供的 FileAllowed 是在服务器端验证上传文件，使用 HTML5 中的 accept 属性也可以在客户端实现简单的类型过滤。这个属性接收 MIME 类型字符串或文件格式后缀，多个值之间使用逗号分隔，比如：</p>
</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;profile_pic&quot;</span> <span class="attr">name</span>=<span class="string">&quot;profile_pic&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;.jpg, .jpeg, .png, .gif&quot;</span> /&gt;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>当用户单击文件选择按钮后，打开的文件选择窗口会默认将 accept 属性值之外的文件过滤掉。尽管如此，用户还是可以选择设定之外的文件，所以仍然需要进行服务器端验证。</p>
</li>
<li><p>除了验证文件的类型，通常还需要对文件大小进行验证，通过设置 Flask 内置的配置变量<strong>MAX_CONTENT_LENGTH</strong>，可以限制请求报文的最大长度，单位为字节（byte）。</p>
</li>
<li><p>比如，下面将最大长度限制为 3M：</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="渲染上传表单"   >
          <a href="#渲染上传表单" class="heading-link"><i class="fas fa-link"></i></a>渲染上传表单</h4>
      <ul>
<li>在新创建的 upload 视图里，实例化表单类 UploadForm，然后传入模板：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    form = UploadForm()</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在模板中渲染上传表单</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.csrf_token &#125;&#125; &#123;&#123; form_field(form.photo) &#125;&#125; &#123;&#123; form.submit &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>唯一需要注意的是，当表单中包含文件上传字段时（即 type 属性为 file 的 input 标签），需要将表单的 enctype 属性设为**”multipart/form-data”**，这会告诉浏览器将上传数据发送到服务器，否则仅会把文件名作为表单数据提交。</li>
</ul>

        <h4 id="处理上传文件"   >
          <a href="#处理上传文件" class="heading-link"><i class="fas fa-link"></i></a>处理上传文件</h4>
      <ul>
<li>单提交后，上传的文件需要在请求对象的 files 属性（<strong>request.files</strong>）中获取，这个属性是 Werkzeug 提供的<strong>ImmutableMultiDict</strong>字典对象，存储字段的 name 键值和文件对象的映射，比如：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImmutableMultiDict([(<span class="string">&#x27;photo&#x27;</span>, &lt;FileStorage: <span class="string">u&#x27;0f913b0ff95.JPG&#x27;</span> (<span class="string">&#x27;image/jpeg&#x27;</span>)&gt;)])</span><br></pre></td></tr></table></div></figure>

<ul>
<li>上传的文件会被 Flask 解析为 Werkzeug 中的<strong>FileStorage 对象</strong>（werkzeug.datastructures.FileStorage）。当手动处理时，需要使用文件上传字段的<strong>name 属性值</strong>作为键获取对应的文件对象。比如：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.files.get(<span class="string">&#x27;photo&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>当使用 Flask-WTF 时，它会自动获取对应的文件对象，这里仍然使用表单类属性的 data 属性获取上传文件。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理上传文件</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>] = os.path.join(app.root_path, <span class="string">&#x27;uploads&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    form = UploadForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        f = form.photo.data</span><br><span class="line">        filename = random_filename(f.filename)</span><br><span class="line">        f.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename))</span><br><span class="line">        flash(<span class="string">&#x27;Upload success.&#x27;</span>)</span><br><span class="line">        session[<span class="string">&#x27;filenames&#x27;</span>] = [filename]</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;show_images&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>当表单通过验证后，我们通过<strong>form.photo.data</strong>获取存储上传文件的 FileStorage 对象。接下来，需要处理文件名，通常有三种处理方式：</p>
</li>
<li><p>使用原文件名</p>
<ul>
<li>如果能够确定文件的来源安全，可以直接使用原文件名，通过 FileStorage 对象的<strong>filename 属性</strong>获取：</li>
</ul>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename = f.filename</span><br></pre></td></tr></table></div></figure>

<ul>
<li>使用过滤后的文件名<ul>
<li>如果要支持用户上传文件，必须对文件名进行处理，因为攻击者可能会在文件名中加入恶意路径。</li>
<li>比如，如果恶意用户在文件名中加入表示上级目录的..（比如../../../../home/username/.bashrc 或../../../etc/passwd），那么当我们保存文件时，如果这里表示上级目录的..数量正确，就会导致服务器上的系统文件被覆盖或篡改，还有可能执行恶意脚本。可以使用 Werkzeug 提供的**secure_filename()**函数对文件名进行过滤，传递文件名作为参数，它会过滤掉所有危险字符，返回”安全的文件名“，如下所示：</li>
</ul>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>secure_filename(<span class="string">&#x27;avatar!@#//#\\%$^&amp;.jpg&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;avatar.jpg&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>secure_filename(<span class="string">&#x27;avatar头像.jpg&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;avatar.jpg&#x27;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>统一重命名<ul>
<li>**secure_filename()**函数非常方便，它会过滤掉文件名中的非 ASCII 字符。但如果文件名完全由非 ASCII 字符组成，那么会得到一个空文件名：</li>
</ul>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>secure_filename(<span class="string">&#x27;头像.jpg&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;jpg&#x27;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>为了避免出现这种情况，更好的做法是使用统一的处理方式对所有上传的文件重新命名。随机文件名有很多种方式可以生成，下面是一个使用 Python 内置的<strong>uuid 模块</strong>生成随机文件名的 random_filename()函数：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_filename</span>(<span class="params">filename</span>):</span></span><br><span class="line">    ext = os.path.splitext(filename)[<span class="number">1</span>]</span><br><span class="line">    new_filename = uuid.uuid4().<span class="built_in">hex</span> + ext</span><br><span class="line">    <span class="keyword">return</span> new_filename</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这个函数接收原文件名作为参数，使用内置的<strong>uuid</strong>模块中的<strong>uuid4()**方法生成新的文件名，并使用</strong>hex 属性**获取十六进制字符串，最后返回包含后缀的新文件名。</li>
</ul>
<blockquote>
<p>UUID（Universally Unique Identifier，通用唯一识别码）是用来标识信息的 128 位数字，比如用作数据库表的主键。使用标准方法生成的 UUID 出现重复的可能性接近 0。在 UUID 的标准中，UUID 分为 5 个版本，每个版本使用不同的生成方法并且适用于不同的场景。使用的 uuid4()方法对应的是第 4 个版本：不接收参数而生成随机 UUID。</p>
</blockquote>
<ul>
<li>在 upload 视图中，调用这个函数来获取随机文件名，传入原文件名作为参数：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename = random_filename(f.filename)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>处理完文件名后，是时候将文件保存到文件系统中了。在 form 目录下创建了一个 uploads 文件夹，用于保存上传后的文件。指向这个文件夹的绝对路径存储在自定义配置变量<strong>UPLOAD_PATH</strong>中：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>] = os.path.join(app.root_path, <span class="string">&#x27;uploads&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这里的路径通过 app.root_path 属性构造，它存储了程序实例所在脚本的绝对路径，相当于<code>os.path.abspath(os.path.dirname(__file__))</code>。为了保存文件，需要提前手动创建这个文件夹。</li>
</ul>
<p>​ 对<strong>FileStorage</strong>对象调用**save()**方法即可保存，传入包含目标文件夹绝对路径和文件名在内的完整保存路径：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename))</span><br></pre></td></tr></table></div></figure>

<ul>
<li>文件保存后，希望能够显示上传后的图片。为了让上传后的文件能够通过 URL 获取，还需要创建一个视图函数来返回上传后的文件，如下所示：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/uploads/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_from_directory(app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这个视图的作用与 Flask 内置的 static 视图类似，通过传入的文件路径返回对应的静态文件。在这个 uploads 视图中，使用 Flask 提供的**send_from_directory()**函数来获取文件，传入文件的路径和文件名作为参数。</li>
</ul>
<blockquote>
<p>在 get_file 视图的 URL 规则中，filename 变量使用了 path 转换器以支持传入包含斜线的路径字符串。</p>
</blockquote>
<ul>
<li>在 upload 视图里保存文件后，使用 flash()发送一个提示，将文件名保存到 session 中，最后重定向到 show_images 视图。show_images 视图返回的 uploaded.html 模板中将从 session 获取文件名，渲染出上传后的图片。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flash(<span class="string">&#x27;Upload success.&#x27;</span>)</span><br><span class="line">session[<span class="string">&#x27;filenames&#x27;</span>] = [filename]</span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;show_images&#x27;</span>))</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>这里将 filename 作为列表传入 session 只是为了兼容下面的多文件上传示例，这两个视图使用同一个模板，使用 session 可以在模板中统一从 session 获取文件名列表。</p>
</blockquote>
<ul>
<li>在 uploaded.html 模板里，将传入的文件名作为 URL 变量，通过上面的 get_file 视图获取文件 URL，作为<code>&lt;img&gt;</code>标签的 src 属性值，如下所示：</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;get_file&#x27;, filename=filename) &#125;&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="多文件上传"   >
          <a href="#多文件上传" class="heading-link"><i class="fas fa-link"></i></a>多文件上传</h4>
      <ul>
<li>因为 Flask-WTF 当前版本（0.14.2）中并未添加对多文件上传的渲染和验证支持，因此需要在视图函数中手动获取文件并进行验证。</li>
<li>在客户端，通过在文件上传字段（type=file）加入 multiple 属性，就可以开启多选：</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">multiple</span> /&gt;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>创建表单类时，可以直接使用 WTForms 提供的<strong>MultipleFileField</strong>字段实现，添加一个 DataRequired 验证器来确保包含文件：</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> MultipleFileField</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiUploadForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    photo = MultipleFileField(<span class="string">&#x27;Upload Image&#x27;</span>, validators=&#123;DataRequired()&#125;)</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></div></figure>

<ul>
<li>表单提交时，在服务器端的程序中，对 request.files 属性调用**getlist()**方法并传入字段的 name 属性值会返回包含所有上传文件对象的列表。在 multi_upload 视图中，迭代这个列表，然后逐一对文件进行处理</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理多文件上传</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, session, flash, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> flask_wtf.csrf <span class="keyword">import</span> validate_csrf</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/multi-upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_upload</span>():</span></span><br><span class="line">    form = MultiUploadForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        filenames = []</span><br><span class="line">        <span class="comment"># 验证CSRF令牌</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            validate_csrf(form.csrf_token.data)</span><br><span class="line">        <span class="keyword">except</span> ValidationError:</span><br><span class="line">            flash(<span class="string">&#x27;CSRF token error.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line">        <span class="comment"># 检查文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;photo&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">            flash(<span class="string">&#x27;This field is required.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> request.files.getlist(<span class="string">&#x27;photo&#x27;</span>):</span><br><span class="line">            <span class="comment"># 检查文件类型</span></span><br><span class="line">            <span class="keyword">if</span> f <span class="keyword">and</span> allowed_file(f.filename):</span><br><span class="line">                filename = random_filename(f.filename)</span><br><span class="line">                f.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename))</span><br><span class="line">                filenames.append(filename)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flash(<span class="string">&#x27;Invalid file type.&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line">        flash(<span class="string">&#x27;Upload success.&#x27;</span>)</span><br><span class="line">        session[<span class="string">&#x27;filenames&#x27;</span>] = filenames</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;show_images&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在请求方法为 POST 时，对上传数据进行手动验证，主要包含下面几步：<ul>
<li>手动调用 flask_wtf.csrf.validate_csrf 验证 CSRF 令牌，传入表单中 csrf_token 隐藏字段的值。如果抛出 wtforms.ValidationError 异常则表明验证未通过。</li>
<li>其中 if’photo’not in request.files 用来确保字段中包含文件数据（相当于 FileRequired 验证器），如果用户没有选择文件就提交表单则 request.files 将为空。</li>
<li>if f 用来确保文件对象存在，这里也可以检查 f 是否是 FileStorage 实例。</li>
<li>allowed_file(f.filename)调用了 allowed_file()函数，传入文件名。这个函数相当于 FileAllowed 验证器，用来验证文件类型，返回布尔值，如下。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证文件类型</span></span><br><span class="line">app.config[<span class="string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>] = [<span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">        filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> app.config[<span class="string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>]</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在上面的几个验证语句里，如果没有通过验证，使用 flash()函数显示错误消息，然后重定向到 multi_upload 视图。</li>
<li>为了方便测试，还创建了一个临时的 filenames 列表，保存上传后的文件名到 session 中。打开多文件上传示例，单击按钮后可以选择多个文件，当上传的文件通过验证时，程序会重定向到 show_images 视图，这个视图返回的 uploaded.html 模板中将从 session 获取所有文件名，渲染出所有上传后的图片。</li>
</ul>
<blockquote>
<p>在新版本的 Flask-WTF 发布后，就可以使用和单文件上传相同的方式处理表单。</p>
<p>比如，可以使用 Flask-WTF 提供的<strong>MultipleFileField</strong>来创建提供 Flask 支持的多文件上传字段，使用相应的验证器对文件进行验证。</p>
<p>在视图函数中，则可以继续使用<strong>form.validate_on_submit()**来验证表单，并通过</strong>form.photo.data**来获取字段的数据——包含所有上传文件对象（werkzeug.datastructures.FileStorage）的列表。</p>
</blockquote>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://blog.zyuanlee.cn">Pandalzy</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://blog.zyuanlee.cn/2019/07/28/Flask%E5%AD%A6%E4%B9%A004-%E8%A1%A8%E5%8D%95/">https://blog.zyuanlee.cn/2019/07/28/Flask%E5%AD%A6%E4%B9%A004-%E8%A1%A8%E5%8D%95/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.zyuanlee.cn/tags/Python3/">Python3</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.zyuanlee.cn/tags/Flask%E5%AD%A6%E4%B9%A0/">Flask学习</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2019/08/11/Flask%E5%AD%A6%E4%B9%A005-%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Flask学习05-数据库</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/07/18/Flask%E5%AD%A6%E4%B9%A003-%E6%A8%A1%E6%9D%BF/"><span class="paginator-prev__text">Flask学习03-模板</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HTML-%E8%A1%A8%E5%8D%95"><span class="toc-number">1.</span> <span class="toc-text">
          HTML 表单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-WTF-%E5%A4%84%E7%90%86%E8%A1%A8%E5%8D%95"><span class="toc-number">2.</span> <span class="toc-text">
          使用 Flask-WTF 处理表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-WTForms-%E8%A1%A8%E5%8D%95%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">
          定义 WTForms 表单类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA-HTMl-%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">
          输出 HTMl 代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-render-kw-%E5%B1%9E%E6%80%A7"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          使用 render_kw 属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%B0%83%E7%94%A8%E5%AD%97%E6%AE%B5%E6%97%B6%E4%BC%A0%E5%85%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          在调用字段时传入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%A8%A1%E6%9D%BF%E4%B8%AD%E6%B8%B2%E6%9F%93%E8%A1%A8%E5%8D%95"><span class="toc-number">2.3.</span> <span class="toc-text">
          在模板中渲染表单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-number">3.</span> <span class="toc-text">
          处理表单数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E8%A1%A8%E5%8D%95"><span class="toc-number">3.1.</span> <span class="toc-text">
          提交表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.</span> <span class="toc-text">
          验证表单数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%AA%8C%E8%AF%81%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%AA%8C%E8%AF%81"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          客户端验证和服务器端验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WTForms-%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          WTForms 验证机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E4%B8%AD%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          在视图函数中验证表单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E4%B8%8E%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.4.</span> <span class="toc-text">
          表单验证与获取数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%A8%A1%E6%9D%BF%E4%B8%AD%E6%B8%B2%E6%9F%93%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.</span> <span class="toc-text">
          在模板中渲染错误消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E8%BF%9B%E9%98%B6%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">
          表单进阶实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%94%99%E8%AF%AF%E6%B6%88%E6%81%AF%E8%AF%AD%E8%A8%80"><span class="toc-number">4.1.</span> <span class="toc-text">
          设置错误消息语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%8F%E6%B8%B2%E6%9F%93%E8%A1%A8%E5%8D%95"><span class="toc-number">4.2.</span> <span class="toc-text">
          使用宏渲染表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text">
          自定义验证器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E5%86%85%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">
          行内验证器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">
          全局验证器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.4.</span> <span class="toc-text">
          文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%A8%E5%8D%95"><span class="toc-number">4.4.1.</span> <span class="toc-text">
          定义上传表单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E4%B8%8A%E4%BC%A0%E8%A1%A8%E5%8D%95"><span class="toc-number">4.4.2.</span> <span class="toc-text">
          渲染上传表单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.3.</span> <span class="toc-text">
          处理上传文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.4.4.</span> <span class="toc-text">
          多文件上传</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/assets/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">Stay hungry, stay foolish.</p></div><div class="sidebar-ov-social"></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">45</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">7</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">31</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Pandalzy</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);</script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script><script type="application/json" src="/search.xml"></script></body></html>