<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/assets/avatar_16x16.jpg?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/assets/avatar_32x32.jpg?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="使用 Flask-SQLAlchemy 管理数据库        安装 Flask-SQLAlchemy 及其依赖  1pip install flask-sqlalchemy   实例化Flask-SQLAlchemy提供的SQLAlchemy类，传入程序实例app，以完成扩展的初始化">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask学习05-数据库">
<meta property="og:url" content="https://blog.zyuanlee.cn/2019/08/11/Flask%E5%AD%A6%E4%B9%A005-%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">
<meta property="og:site_name" content="Pandalzy&#39;s Blog">
<meta property="og:description" content="使用 Flask-SQLAlchemy 管理数据库        安装 Flask-SQLAlchemy 及其依赖  1pip install flask-sqlalchemy   实例化Flask-SQLAlchemy提供的SQLAlchemy类，传入程序实例app，以完成扩展的初始化">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-08-11T13:33:03.000Z">
<meta property="article:modified_time" content="2021-06-27T00:34:28.398Z">
<meta property="article:author" content="Pandalzy">
<meta property="article:tag" content="Python3">
<meta property="article:tag" content="Flask学习">
<meta name="twitter:card" content="summary"><title>Flask学习05-数据库 | Pandalzy's Blog</title><link ref="canonical" href="https://blog.zyuanlee.cn/2019/08/11/Flask%E5%AD%A6%E4%B9%A005-%E6%95%B0%E6%8D%AE%E5%BA%93/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-address-card"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-user-friends"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Pandalzy's Blog</div><div class="header-banner-info__subtitle">Stay hungry, stay foolish.</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Flask学习05-数据库</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-08-11</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-06-27</span></span></div></header><div class="post-body">
        <h2 id="使用-Flask-SQLAlchemy-管理数据库"   >
          <a href="#使用-Flask-SQLAlchemy-管理数据库" class="heading-link"><i class="fas fa-link"></i></a>使用 Flask-SQLAlchemy 管理数据库</h2>
      <ul>
<li>安装 Flask-SQLAlchemy 及其依赖</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-sqlalchemy</span><br></pre></td></tr></table></div></figure>

<ul>
<li>实例化<strong>Flask-SQLAlchemy</strong>提供的<strong>SQLAlchemy</strong>类，传入程序实例<strong>app</strong>，以完成扩展的初始化<span id="more"></span>

</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></div></figure>


        <h3 id="连接数据库服务器"   >
          <a href="#连接数据库服务器" class="heading-link"><i class="fas fa-link"></i></a>连接数据库服务器</h3>
      <ul>
<li>常用的数据库 URI 格式</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>DBMS</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>PostgreSQL</td>
<td>postgresql://username:password@host/databasename</td>
</tr>
<tr>
<td>MySQL</td>
<td>mysql://username:password@host/databasename<br/>mysql+pymysql://username:password@host/databasename</td>
</tr>
<tr>
<td>Oracle</td>
<td>oracle://username:password@host:port/sidname</td>
</tr>
<tr>
<td>SQLite(UNIX)</td>
<td>sqlite:////absollute/path/to/foo.db</td>
</tr>
<tr>
<td>SQLite(Windows)</td>
<td>sqlite:///absollute\path\to\foo.db 或<br/>r’sqlite:///absollute\path\to\foo.db’</td>
</tr>
<tr>
<td>SQLite(内存型)</td>
<td>sqlite:///或 sqlite///:memory</td>
</tr>
</tbody></table></div>
<ul>
<li>在<strong>Flask-SQLAlchemy</strong>中，数据库的 URI 通过配置变量<strong>SQLALCHEMY_DATABASE_URI</strong>设置，默认为 SQLite 内存型数据库（sqlite///:memory）。SQLite 是基于文件的 DBMS，不需要设置数据库服务器，只需要指定数据库文件的绝对路径。使用<code>app.root_path</code>来定位数据库文件的路径，并将数据库文件命名为<strong>data.db</strong></li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置数据库URI</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = os.getenv(<span class="string">&#x27;DATABASE_URL&#x27;</span>, <span class="string">&#x27;sqlite:///&#x27;</span> + os.path.join(app.root_path, <span class="string">&#x27;data.db&#x27;</span>))</span><br></pre></td></tr></table></div></figure>

<ul>
<li><strong>SQLALCHEMY_TRACK_MODIFICATIONS</strong>配置变量，这个配置变量决定是否追踪对象的修改，这用于<strong>Flask-SQLAlchemy</strong>的事件通知系统，这个配置键的默认值为 None，如果没有特殊需要，可以把它设为 False 来关闭警告信息</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="定义数据模型"   >
          <a href="#定义数据模型" class="heading-link"><i class="fas fa-link"></i></a>定义数据模型</h3>
      <ul>
<li>所有的模型类都需要继承 Flask-SQLAlchemy 提供的<strong>db.Model</strong>基类</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义Note模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Note</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>SQLAlchemy 常用的字段类型</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Integer</td>
<td>整数</td>
</tr>
<tr>
<td>String</td>
<td>字符串，可选参数 length 可以用来设置最大长度</td>
</tr>
<tr>
<td>Text</td>
<td>较长的 Unicode 文本</td>
</tr>
<tr>
<td>Date</td>
<td>日期，存储 datetime.date 对象</td>
</tr>
<tr>
<td>Time</td>
<td>时间，存储 datetime.time 对象</td>
</tr>
<tr>
<td>DataTime</td>
<td>时间和日期，存储 datetime 对戏那个</td>
</tr>
<tr>
<td>Interval</td>
<td>时间间隔，存储 datetime.timedelta 对象</td>
</tr>
<tr>
<td>Float</td>
<td>浮点数</td>
</tr>
<tr>
<td>Boolean</td>
<td>布尔型</td>
</tr>
<tr>
<td>PickleType</td>
<td>存储 Pickle 列化的 Python 对象</td>
</tr>
<tr>
<td>LargeBinary</td>
<td>存储任意二进制数据</td>
</tr>
</tbody></table></div>
<blockquote>
<p>字段类型一般直接声明即可，如果传入参数，可以加括号</p>
<p>String 类型需要指定长度</p>
<p>Text 类型可用于变长文本，如用户发表的文章或者评论等</p>
</blockquote>
<ul>
<li>默认情况下，Flask-SQLAlchemy 会根据模型类的名称生成一个表名称，生成规则如下：</li>
</ul>
<figure class="highlight"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Message --&gt; message # 单个单词转换为小写</span><br><span class="line">FooBar --&gt; foo_bar # 多个单词转换为小写并使用下划线分隔</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>如果需要自己指定表名称，可以定义<code>__tablename__</code>属性来实现</p>
</li>
<li><p>常用的 SQLAlchemy 字段参数</p>
</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>primary_key</td>
<td>如果设为 True，该字段为主键</td>
</tr>
<tr>
<td>unique</td>
<td>如果设为 True，该字段不允许出现重复值</td>
</tr>
<tr>
<td>index</td>
<td>如果为 True，该字段创建索引，以提高查询效率</td>
</tr>
<tr>
<td>nullable</td>
<td>确定字段值可为空，值为 True 或 False，默认为 True</td>
</tr>
<tr>
<td>default</td>
<td>为字段设置默认值</td>
</tr>
</tbody></table></div>
<ul>
<li>不需要在所有列都建立索引。</li>
<li>一般来说，取值可能性多（比如姓名）的列，以及经常被用来作为排序参照的列（比如时间戳）更适合建立索引。</li>
</ul>

        <h3 id="创建数据库和表"   >
          <a href="#创建数据库和表" class="heading-link"><i class="fas fa-link"></i></a>创建数据库和表</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; from app import db</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.create_all()</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>如果模型类定义在单独的模块中，必须在调用<code>db.create_all()</code>方法前导入相应模块</p>
</blockquote>
<ul>
<li>查看模型对应的 SQL 模式</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; from sqlalchemy.schema import CreateTable</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; <span class="built_in">print</span>(CreateTable(Note.__table__))</span></span><br><span class="line"></span><br><span class="line">CREATE TABLE note (</span><br><span class="line">    id INTEGER NOT NULL,</span><br><span class="line">    body TEXT,</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">)</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>数据库和表创建后，之后对模型的改动不会自动更新在实际的表中。</p>
<p>需要使用<code>db.drop_all()</code>之后，再调用<code>drop.create_all()</code></p>
</blockquote>

        <h2 id="数据库操作"   >
          <a href="#数据库操作" class="heading-link"><i class="fas fa-link"></i></a>数据库操作</h2>
      <ul>
<li>数据库操作主要是 CRUD，即 Create（创建）、Read（读取/查询）、Update（更新）和 Delete（删除）</li>
<li>SQLAlchemy 使用数据库会话来管理数据库操作，这里的数据库会话也称为事务（transaction）。</li>
<li>Flask-SQLAlchemy 自动创建会话，可以通过 db.session 属性获取</li>
</ul>
<blockquote>
<p><code>add()</code>可以将创建的对象添加到数据回话中，或者对会话中的对象进行更新，只有使用<code>commit()</code>方法，改动才会被提交到数据库。数据库也支持回滚操作，调用<code>rollback()</code>方法时，添加到会话中且未提交的改动都将被撤销</p>
</blockquote>

        <h3 id="CRUD"   >
          <a href="#CRUD" class="heading-link"><i class="fas fa-link"></i></a>CRUD</h3>
      <ul>
<li>默认情况下，Flask-SQLAlchemy（&gt;=2.3.0 版本）会自动为模型类生成一个<code>__repr__()</code>方法。当在 Python Shell 中调用模型的对象时，<code>__repr__()</code>方法会返回一条类似“&lt;模型类名主键值&gt;”的字符串，比如&lt;Note 2&gt;</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Note</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 重新定义了__repr__</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Note %r&gt;&#x27;</span> % self.body</span><br></pre></td></tr></table></div></figure>


        <h4 id="Create"   >
          <a href="#Create" class="heading-link"><i class="fas fa-link"></i></a>Create</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from app import db, Note</span><br><span class="line">&gt;&gt;&gt; note1 &#x3D; Note(body&#x3D;&#39;remember Sammy Jankis&#39;)</span><br><span class="line">&gt;&gt;&gt; note2 &#x3D; Note(body&#x3D;&#39;SHAVE&#39;)</span><br><span class="line">&gt;&gt;&gt; note3 &#x3D; Note(body&#x3D;&#39;DON&#39;T BELIEVE HIS LIES, HE IS THE ONE, KILL HIM&#39;)</span><br><span class="line">&gt;&gt;&gt; db.session.add(note1)</span><br><span class="line">&gt;&gt;&gt; db.session.add(note2)</span><br><span class="line">&gt;&gt;&gt; db.session.add(note3)</span><br><span class="line">&gt;&gt;&gt; db.session.commit()</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>除了依次调用<code>add()</code>方法添加多个记录，也可以使用<code>add_all()</code>一次添加包含所有记录对象的列表</p>
<p>Flask-SQLAlchemy 提供了一个<strong>SQLALCHEMY_COMMIT_ON_TEARDOWN</strong>配置变量，将其设为 True 可以设置自动调用<code>commit()</code>方法提交数据库会话。因为存在潜在的 Bug，目前已不建议使用，而且未来版本中将移除该配置变量。避免使用该配置变量，可使用手动调用<code>db.session.commit()</code>方法的方式提交数据库会话</p>
</blockquote>

        <h4 id="Read"   >
          <a href="#Read" class="heading-link"><i class="fas fa-link"></i></a>Read</h4>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;模型类&gt;.query.&lt;过滤方法&gt;.&lt;查询方法&gt;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>常用过滤方法</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>过滤方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>filter()</td>
<td>使用指定的规则过滤记录，返回新产生的查询对象</td>
</tr>
<tr>
<td>filter_by()</td>
<td>使用指定规则过滤记录（以关键字表达式的形式），返回新产生的查询对象</td>
</tr>
<tr>
<td>order_by()</td>
<td>根据指定条件对记录进行排序，返回新产生的查询对象</td>
</tr>
<tr>
<td>limit(limit)</td>
<td>使用指定的值限制原查询返回的记录数量，返回新产生的查询对象</td>
</tr>
<tr>
<td>group_by()</td>
<td>根据指定条件对记录进行分组，返回新产生的查询对象</td>
</tr>
<tr>
<td>offset(sooset)</td>
<td>使用指定的值偏移原查询的结果，返回新产生的查询对象</td>
</tr>
</tbody></table></div>
<ul>
<li>常用查询方法</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>查询方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>all()</td>
<td>返回包含所有查询记录的列表</td>
</tr>
<tr>
<td>first()</td>
<td>返回查询的第一条，未找到返回 None</td>
</tr>
<tr>
<td>one()</td>
<td>返回第一条记录，且仅允许有一条记录，如果数量大于 1 或者小于 1，则抛出异常 get</td>
</tr>
<tr>
<td>get(ident)</td>
<td>主键作为参数，返回指定主键值的记录，如果未找到，则返回 None</td>
</tr>
<tr>
<td>count()</td>
<td>返回查询结果的数量</td>
</tr>
<tr>
<td>one_or_none()</td>
<td>类似 one()，如果数量不为 1，则返回 None</td>
</tr>
<tr>
<td>first_or_404()</td>
<td>返回查询的第一条记录，如果未找到，则返回 404 错误</td>
</tr>
<tr>
<td>get_or_404()</td>
<td>主键作为参数，返回指定主键值的记录，如果未找到，则返回 404</td>
</tr>
<tr>
<td>paginate()</td>
<td>返回一个 Pagination 对象，可以对记录进行分页处理</td>
</tr>
<tr>
<td>with_parent(instance)</td>
<td>传入模型实例作为参数，返回和这个实例相关联的对象</td>
</tr>
</tbody></table></div>
<ul>
<li>查看对应的查询语句</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; <span class="built_in">print</span>(News.query.filter_by(title=<span class="string">&#x27;abc&#x27;</span>))</span></span><br><span class="line">SELECT news.new_id AS news_new_id, news.title AS news_title, news.new_url AS news_new_url, news.time AS news_time</span><br><span class="line">FROM news</span><br><span class="line">WHERE news.title = %(title_1)s</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>filter()方法中传递的表达式</p>
<ul>
<li>==或!=</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">News.query.<span class="built_in">filter</span>(News.title==<span class="string">&#x27;abc&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>LIKE</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">News.query.<span class="built_in">filter</span>(News.title.like(<span class="string">&#x27;abc&#x27;</span>))</span><br></pre></td></tr></table></div></figure>

<ul>
<li>IN</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">News.query.<span class="built_in">filter</span>(News.title.in_([<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;def&#x27;</span>]))</span><br></pre></td></tr></table></div></figure>

<ul>
<li>NOT IN</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">News.query.<span class="built_in">filter</span>(~News.title.in_([<span class="string">&#x27;abc&#x27;</span>,<span class="string">&#x27;def&#x27;</span>]))</span><br></pre></td></tr></table></div></figure>

<ul>
<li>AND</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_</span><br><span class="line">News.query.<span class="built_in">filter</span>(and_(News.new_id==<span class="string">&#x27;1000&#x27;</span>, News.title==<span class="string">&#x27;abc&#x27;</span>))</span><br><span class="line"></span><br><span class="line">News.query.<span class="built_in">filter</span>(News.new_id==<span class="string">&#x27;1000&#x27;</span>, News.title==<span class="string">&#x27;abc&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>OR</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span><br><span class="line">News.query.<span class="built_in">filter</span>(or_(News.title == <span class="string">&#x27;foo&#x27;</span>, News.title == <span class="string">&#x27;bar&#x27;</span>))</span><br></pre></td></tr></table></div></figure>
</li>
<li><p>和<code>filter()</code>方法相比，<code>filter_by()</code>方法更易于使用。在<code>filter_by()</code>方法中，可以使用关键字表达式来指定过滤规则。更方便的是，可以在这个过滤器中直接使用字段名称。</p>
<ul>
<li><code>News.query.filter_by(title=&#39;abc&#39;).first()</code></li>
</ul>
</li>
</ul>

        <h4 id="Update"   >
          <a href="#Update" class="heading-link"><i class="fas fa-link"></i></a>Update</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new = News.query.get(<span class="number">1001</span>)</span><br><span class="line">new.title = <span class="string">&#x27;def&#x27;</span></span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>只有要插入新的记录或要将现有的记录添加到会话中时才需要使用<code>add()</code>方法，单纯要更新现有的记录时只需要直接为属性赋新值，然后提交会话</p>
</blockquote>

        <h4 id="Delete"   >
          <a href="#Delete" class="heading-link"><i class="fas fa-link"></i></a>Delete</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new = News.query.get(<span class="number">1001</span>)</span><br><span class="line">db.session.delete(new)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></div></figure>


        <h2 id="定义关系"   >
          <a href="#定义关系" class="heading-link"><i class="fas fa-link"></i></a>定义关系</h2>
      <ul>
<li>每一次使用<strong>shell</strong>命令启动 Python Shell 后都要从 app 模块里导入 db 对象和相应的模型类，集成在<strong>shell</strong>上下文，简化工作</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册shell上下文处理函数</span></span><br><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_shell_context</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(db=db, News=News)  <span class="comment"># 等同于&#123;&#x27;db&#x27;: db, &#x27;News&#x27;: News&#125;</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="一对多"   >
          <a href="#一对多" class="heading-link"><i class="fas fa-link"></i></a>一对多</h3>
      <ul>
<li>一个作者可以写作多篇文章</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    phone = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在“一”一侧定义</span></span><br><span class="line">    articles = db.relationship(<span class="string">&#x27;Article&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在“多”一侧定义</span></span><br><span class="line">    author_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;author.id&#x27;</span>))</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>关系属性的名称没有限制，可以自由修改。它相当于一个快捷查询，不会作为字段写入数据库中。</p>
</blockquote>
<ul>
<li><p>articles 使用了<code>db.relationship()</code>关系函数定义为关系属性，这个关系属性返回多个记录，为集合关系属性。<code>relationship()</code>函数的第一个参数为关系另一侧的模型名称，它会告诉<strong>SQLAlchemy</strong>将<strong>Author 类</strong>与<strong>Article 类</strong>建立关系。</p>
</li>
<li><p>当这个关系属性被调用时，SQLAlchemy 会找到关系另一侧（即 article 表）的外键字段（即 author_id），然后反向查询 article 表中所有 author_id 值为当前表主键值（即 author.id）的记录，返回包含这些记录的列表，也就是返回某个作者对应的多篇文章记录。</p>
</li>
<li><p>建立关系的方法</p>
<ul>
<li>直接赋值<ul>
<li><code>arc.author_id = 1</code></li>
</ul>
</li>
<li>操作关系属性 append<ul>
<li><code>foo.articles.append(spam)</code></li>
</ul>
</li>
<li>remove<ul>
<li><code>foo.articles.remove(spam)</code></li>
</ul>
</li>
<li>pop</li>
</ul>
</li>
<li><p>常用 SQLAlchemy 关系函数参数</p>
</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>back_populates</td>
<td>定义反向引用，用于建立双向关系，在关系的另一侧也必须显式定义关系属性</td>
</tr>
<tr>
<td>backref</td>
<td>添加反向引用，自动在另一侧建立关系属性，是 back_populates 的简化版</td>
</tr>
<tr>
<td>lazy</td>
<td>指定如何加载相关记录，具体如下表所示</td>
</tr>
<tr>
<td>uselist</td>
<td>指定是否使用列表的形式加载记录，设为 False 则使用标量（scalar）</td>
</tr>
<tr>
<td>cascade</td>
<td>设置级联操作</td>
</tr>
<tr>
<td>order_by</td>
<td>指定加载相关记录时的排序方式</td>
</tr>
<tr>
<td>scondary</td>
<td>在多对多关系中指定关联表</td>
</tr>
<tr>
<td>primaryjoin</td>
<td>指定多对多关系中的一级联结条件</td>
</tr>
<tr>
<td>secondaryjoin</td>
<td>指定多对多关系中的二级联结条件</td>
</tr>
</tbody></table></div>
<ul>
<li>lazy 参数的常用选项</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>关系加载方式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>select</td>
<td>在必要时一次性加载记录，返回包含记录的列表（默认值），等同于 lazy=True</td>
</tr>
<tr>
<td>joined</td>
<td>和父查询一样加载记录，但使用联接，等同于 lazy=False</td>
</tr>
<tr>
<td>immediate</td>
<td>一旦父查询加载就加载</td>
</tr>
<tr>
<td>subquery</td>
<td>类似于 joined，不顾将使用子查询</td>
</tr>
<tr>
<td>dynamic</td>
<td>不直接加载记录，而是返回一个包含相关记录的 query 对象，以便再继续附加查询函数对结果进行过滤</td>
</tr>
</tbody></table></div>
<blockquote>
<p>dynamic 选项仅用于集合关系属性，</p>
<p>不可用于多对一、一对一或是在关系函数中将 uselist 参数设为 False 的情况</p>
</blockquote>
<blockquote>
<p>许多教程和示例使用 dynamic 来动态加载所有集合关系属性对应的记录，这是应该避免的行为。</p>
<p>使用 dynamic 加载方式意味着每次操作关系都会执行一次 SQL 查询，这会造成潜在的性能问题。</p>
<p>大多数情况下只需要使用默认值（select），只有在调用关系属性会返回大量记录，并且总是需要对关系属性返回的结果附加额外的查询时才需要使用动态加载（lazy=’dynamic’）</p>
</blockquote>

        <h4 id="建立双向关系"   >
          <a href="#建立双向关系" class="heading-link"><i class="fas fa-link"></i></a>建立双向关系</h4>
      <ul>
<li>双向关系并不是必须的，但在某些情况下会非常方便。双向关系的建立很简单，通过在关系的另一侧也创建一个<code>relationship()</code>函数，就可以在两个表之间建立双向关系</li>
<li>使用作家（Writer）和书（Book）的一对多关系来进行演示，建立双向关系后的 Writer 和 Book 类</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    books = db.relationship(<span class="string">&#x27;Book&#x27;</span>, back_populates=<span class="string">&#x27;writer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    writer_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;writer.id&#x27;</span>))</span><br><span class="line">    writer = db.relationship(<span class="string">&#x27;Writer&#x27;</span>, back_populates=<span class="string">&#x27;books&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在关系函数中，使用<strong>back_populates</strong>参数来连接对方，<strong>back_populates</strong>参数的值需要设为关系另一侧的关系属性名。</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 先创建1个Writer和2个Book记录，并添加到数据库</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; king = Writer(name=<span class="string">&#x27;Stephen King&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; carrie = Book(name=<span class="string">&#x27;Carrie&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; it = Book(name=<span class="string">&#x27;IT&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(king)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(carrie)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(it)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br></pre></td></tr></table></div></figure>

<figure class="highlight sh"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试</span></span><br><span class="line">&gt;&gt;&gt; carrie.writer = king</span><br><span class="line">&gt;&gt;&gt; carrie.writer</span><br><span class="line">&lt;Writer u<span class="string">&#x27;Stephen King&#x27;</span>&gt;</span><br><span class="line">&gt;&gt;&gt; king.books</span><br><span class="line">[&lt;Book u<span class="string">&#x27;Carrie&#x27;</span>&gt;]</span><br><span class="line">&gt;&gt;&gt; it.writer = king</span><br><span class="line">&gt;&gt;&gt; king.books</span><br><span class="line">[&lt;Book u<span class="string">&#x27;Carrie&#x27;</span>&gt;, &lt;Book u<span class="string">&#x27;IT&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解除关系</span></span><br><span class="line">&gt;&gt;&gt; carrie.writer = None</span><br><span class="line">&gt;&gt;&gt; king.books</span><br><span class="line">[&lt;Book u<span class="string">&#x27;IT&#x27;</span>&gt;]</span><br><span class="line">&gt;&gt;&gt; db.session.commit()</span><br></pre></td></tr></table></div></figure>


        <h4 id="使用-backref-简化关系定义"   >
          <a href="#使用-backref-简化关系定义" class="heading-link"><i class="fas fa-link"></i></a>使用 backref 简化关系定义</h4>
      <ul>
<li>以一对多关系为例，backref 参数用来自动为关系另一侧添加关系属性，作为反向引用（back reference），赋予的值会作为关系另一侧的关系属性名称。</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singer</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    songs = db.relationship(<span class="string">&#x27;Song&#x27;</span>, backref=<span class="string">&#x27;singer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    singer_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;singer.id&#x27;</span>))</span><br></pre></td></tr></table></div></figure>

<ul>
<li>在定义集合属性 songs 的关系函数中，将 backref 参数设为 singer，这会同时在 Song 类中添加了一个 singer 标量属性。</li>
<li>这时仅需要定义一个关系函数，虽然 singer 是一个“看不见的关系属性”，但在使用上和定义两个关系函数并使用<strong>back_populates</strong>参数的效果完全相同</li>
</ul>
<blockquote>
<p>希望可以对在关系另一侧的关系属性进行设置，这时就需要使用<code>backref()</code>函数。<code>backref()</code>函数接收第一个参数作为在关系另一侧添加的关系属性名，其他关键字参数会作为关系另一侧关系函数的参数传入。</p>
<p>比如，我们要在关系另一侧“看不见的<code>relationship()</code>函数”中将 uselist 参数设为 False，可以这样实现</p>
</blockquote>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singer</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    songs = relationship(<span class="string">&#x27;Song&#x27;</span>, backref=backref(<span class="string">&#x27;singer&#x27;</span>, uselist=<span class="literal">False</span>))</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>尽管使用<strong>backref</strong>非常方便，但通常来说“显式好过隐式”，所以应该尽量使用<strong>back_populates</strong>定义双向关系</p>
</blockquote>

        <h3 id="多对一"   >
          <a href="#多对一" class="heading-link"><i class="fas fa-link"></i></a>多对一</h3>
      <ul>
<li>多个居民居住在同一个城市</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Citizen</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    city_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;city.id&#x27;</span>))</span><br><span class="line">    city = db.relationship(<span class="string">&#x27;City&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">City</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这时定义的 city 关系属性是一个标量属性（返回单一数据）。</li>
<li>当 Citizen.city 被调用时，SQLAlchemy 会根据外键字段 city_id 存储的值查找对应的 City 对象并返回，即居民记录对应的城市记录</li>
</ul>
<blockquote>
<p>当建立双向关系时，如果不使用<strong>backref</strong>，那么一对多和多对一关系模式在定义上完全相同，这时可以将一对多和多对一视为同一种关系模式</p>
</blockquote>

        <h3 id="一对一"   >
          <a href="#一对一" class="heading-link"><i class="fas fa-link"></i></a>一对一</h3>
      <ul>
<li>每个国家只有一个首都</li>
<li>Country 类表示国家，Capital 类表示首都</li>
<li>要确保关系两侧的关系属性都是标量属性，都只返回单个值，所以要在定义集合属性的关系函数中将 uselist 参数设为 False，这时一对多关系将被转换为一对一关系</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    capital = db.relationship(<span class="string">&#x27;Capital&#x27;</span>, uselist=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Capital</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    country_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;country.id&#x27;</span>))</span><br><span class="line">    country = db.relationship(<span class="string">&#x27;Country&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; china = Country(name=<span class="string">&#x27;China&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; beijing = Capital(name=<span class="string">&#x27;Beijing&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(china)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(beijing)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; china.capital = beijing</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; china.capital</span></span><br><span class="line">&lt;Capital 1&gt;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; beijing.country</span></span><br><span class="line">u&#x27;China&#x27;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; tokyo = Capital(name<span class="string">&#x27;Tokyo&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; china.capital.append(tokyo)</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File &quot;&lt;console&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &#x27;Capital&#x27; object has no attribute &#x27;append&#x27;</span><br></pre></td></tr></table></div></figure>


        <h3 id="多对多"   >
          <a href="#多对多" class="heading-link"><i class="fas fa-link"></i></a>多对多</h3>
      <ul>
<li>每个学生有多个老师，而每个老师有多个学生</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">association_table = db.Table(</span><br><span class="line">    <span class="string">&#x27;association&#x27;</span>,</span><br><span class="line">    db.Column(</span><br><span class="line">        <span class="string">&#x27;student_id&#x27;</span>,</span><br><span class="line">        db.Integer,</span><br><span class="line">        db.ForeignKey(<span class="string">&#x27;student.id&#x27;</span>)</span><br><span class="line">    ),</span><br><span class="line">    db.Column(</span><br><span class="line">        <span class="string">&#x27;teacher_id&#x27;</span>,</span><br><span class="line">        db.Integer,</span><br><span class="line">        db.ForeignKey(<span class="string">&#x27;teacher.id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    grade = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    teachers = db.relationship(</span><br><span class="line">        <span class="string">&#x27;Teacher&#x27;</span>,</span><br><span class="line">        secondary=association_table,</span><br><span class="line">        back_populates=<span class="string">&#x27;students&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    office = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    students = db.relationship(</span><br><span class="line">        <span class="string">&#x27;Student&#x27;</span>,</span><br><span class="line">        secondary=association_table,</span><br><span class="line">        back_populates=<span class="string">&#x27;teachers&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>可以使用<code>append()</code>与<code>remove()</code>方法</p>
</blockquote>

        <h2 id="使用-Flask-Migrate-迁移数据库"   >
          <a href="#使用-Flask-Migrate-迁移数据库" class="heading-link"><i class="fas fa-link"></i></a>使用 Flask-Migrate 迁移数据库</h2>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-migrate</span><br></pre></td></tr></table></div></figure>

<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">...</span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">migrate = Migrate(app, db)  <span class="comment"># 在db对象创建后调用</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="创建迁移环境"   >
          <a href="#创建迁移环境" class="heading-link"><i class="fas fa-link"></i></a>创建迁移环境</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> flask db init</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>Flask-Migrate 提供了一个命令集，使用 db 作为命名集名称，它提供的命令都以<code>flask db</code>开头。可以在命令行中输入<code>flask--help</code>查看所有可用的命令和说明</p>
</blockquote>
<ul>
<li>迁移环境只需要创建一次。这会在项目根目录下创建一个 migrations 文件夹，其中包含了自动生成的配置文件和迁移版本文件夹</li>
</ul>

        <h3 id="生成迁移脚本"   >
          <a href="#生成迁移脚本" class="heading-link"><i class="fas fa-link"></i></a>生成迁移脚本</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> flask db migrate -m <span class="string">&quot;add note timestamp&quot;</span></span></span><br><span class="line">...</span><br><span class="line">INFO [alembic.autogenerate.compare] Detected added column &#x27;message.timestamp</span><br><span class="line">Generating /Path/to/your/database/migrations/versions/c52a02014635_add note_timestamp.py ... done</span><br></pre></td></tr></table></div></figure>

<ul>
<li>这条命令可以简单理解为在 flask 里对数据库（db）进行迁移（migrate）。-m 选项用来添加迁移备注信息。</li>
<li>从上面的输出信息可以看到，Alembic 检测出了模型的变化：表 note 新添加了一个 timestamp 列，并且相应生成了一个迁移脚本 c52a02014635_add_note_timestamp.py</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;add note timastamp</span></span><br><span class="line"><span class="string">Revision ID: c52a02014635</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> alembic <span class="keyword">import</span> op</span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span>():</span></span><br><span class="line">    <span class="comment"># ### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.add_column(<span class="string">&#x27;note&#x27;</span>, sa.Column(<span class="string">&#x27;timestamp&#x27;</span>, sa.DateTime(), nullable=<span class="literal">True</span>))</span><br><span class="line">    <span class="comment"># ### end Alembic commands ###</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downgrade</span>():</span></span><br><span class="line">    <span class="comment"># ### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.drop_column(<span class="string">&#x27;note&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>)</span><br><span class="line">    <span class="comment"># ### end Alembic commands ###</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>从上面的代码可以看出，迁移脚本主要包含了两个函数：<ul>
<li><code>upgrade()</code>函数用来将改动应用到数据库，函数中包含了向表中添加 timestamp 字段的命令；</li>
<li>而<code>downgrade()</code>函数用来撤销改动，包含了删除 timestamp 字段的命令</li>
</ul>
</li>
<li>有些复杂的操作无法实现自动迁移，这时可以使用 revision 命令手动创建迁移脚本。这同样会生成一个迁移脚本，不过脚本中的<code>upgrade()</code>和<code>downgrade()</code>函数都是空的。需要使用 Alembic 提供的<strong>Operations</strong>对象指令在这两个函数中实现具体操作</li>
</ul>

        <h3 id="更新数据库"   >
          <a href="#更新数据库" class="heading-link"><i class="fas fa-link"></i></a>更新数据库</h3>
      <ul>
<li>生成了迁移脚本后，使用 upgrade 子命令即可更新数据库</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; $ flask db upgrade</span></span><br><span class="line">...INFO  [alembic.runtime.migration] Running upgrade  -&gt; c52a02014635, add note timestamp</span><br></pre></td></tr></table></div></figure>

<ul>
<li>生成了迁移脚本后，使用 upgrade 子命令即可更新数据库</li>
</ul>
<blockquote>
<p>如果想回滚迁移，那么可以使用 downgrade 命令（降级），它会撤销最后一次迁移在数据库中的改动，这在开发时非常有用。</p>
</blockquote>

        <h2 id="进阶"   >
          <a href="#进阶" class="heading-link"><i class="fas fa-link"></i></a>进阶</h2>
      
        <h3 id="级联操作"   >
          <a href="#级联操作" class="heading-link"><i class="fas fa-link"></i></a>级联操作</h3>
      <ul>
<li><strong>Cascade</strong>意为“级联操作”，就是在操作一个对象的同时，对相关的对象也执行某些操作。</li>
<li>通过一个 Post 模型和 Comment 模型来演示级联操作，分别表示文章（帖子）和评论，两者为一对多关系</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># comments = db.relationship(&#x27;Comment&#x27;, back_populates=&#x27;post&#x27;)</span></span><br><span class="line">    comments = relationship(<span class="string">&#x27;Comment&#x27;</span>, cascade=<span class="string">&#x27;save-update, merge, delete&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    post_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;post.id&#x27;</span>))</span><br><span class="line">    post = db.relationship(<span class="string">&#x27;Post&#x27;</span>, back_populates=<span class="string">&#x27;comments&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>常用配置组合<ul>
<li><code>save-update, merge</code>（默认值）</li>
<li><code>save-update, merge, delete</code></li>
<li><code>all</code></li>
<li><code>all, delete-orphan</code></li>
</ul>
</li>
</ul>

        <h4 id="save-update"   >
          <a href="#save-update" class="heading-link"><i class="fas fa-link"></i></a>save-update</h4>
      <ul>
<li><code>save-update</code>是默认的级联行为，当<code>cascade</code>参数设为<code>save-update</code>时，如果使用<code>db.session.add()</code>方法将 Post 对象添加到数据库会话时，那么与 Post 相关联的 Comment 对象也将被添加到数据库会话</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post1 = Post()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment1 = Comment()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment2 = Comment()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(post1)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post1 <span class="keyword">in</span> db.session</span></span><br><span class="line">True</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment1 <span class="keyword">in</span> db.session</span></span><br><span class="line">False</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment2 <span class="keyword">in</span> db.session</span></span><br><span class="line">False</span><br></pre></td></tr></table></div></figure>

<ul>
<li>如果让 post1 与这两个 Comment 对象建立关系，那么这两个 Comment 对象也会自动被添加到数据库会话中</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post1.comments.append(comment1)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post1.comments.append(comment2)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment1 <span class="keyword">in</span> db.session</span></span><br><span class="line">True</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment2 <span class="keyword">in</span> db.session</span></span><br><span class="line">True</span><br></pre></td></tr></table></div></figure>

<ul>
<li>当调用<code>db.session.commit()</code>提交数据库会话时，这三个对象都会被提交到数据库中</li>
</ul>

        <h4 id="delete"   >
          <a href="#delete" class="heading-link"><i class="fas fa-link"></i></a>delete</h4>
      <ul>
<li><p>如果某个 Post 对象被删除，那么按照默认的行为，该 Post 对象相关联的所有 Comment 对象都将与这个 Post 对象取消关联，外键字段的值会被清空。</p>
</li>
<li><p>如果 Post 类的关系函数中<code>cascade</code>参数设为<strong>delete</strong>时，这些相关的 Comment 会在关联的 Post 对象删除时被一并删除。当需要设置<strong>delete</strong>级联时，将级联值设为<code>all</code>或<code>save-update, merge, delete</code></p>
</li>
<li><p>创建一个文章对象 post2 和两个评论对象 comment3 和 comment4，并将这两个评论对象与文章对象建立关系，将它们添加到数据库会话并提交</p>
</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post2 = Post()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment3 = Comment()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment4 = Comment()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post2.comments.append(comment3)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post2.comments.append(comment4)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(post2)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Post.query.all()</span></span><br><span class="line">[&lt;Post 1&gt;, &lt;Post 2&gt;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Comment.query.all()</span></span><br><span class="line">[&lt;Comment 1&gt;, &lt;Comment 2&gt;, &lt;Comment 3&gt;, &lt;Comment 4&gt;]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post2 = Post.quer2y.get(2)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.delete(post2)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Post.query.all()</span></span><br><span class="line">[&lt;Post 1&gt;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Comment.query.all()</span></span><br><span class="line">[&lt;Comment 1&gt;, &lt;Comment 2&gt;]</span><br></pre></td></tr></table></div></figure>


        <h4 id="delete-orphan"   >
          <a href="#delete-orphan" class="heading-link"><i class="fas fa-link"></i></a>delete-orphan</h4>
      <ul>
<li>这个模式是基于 delete 级联的，必须和 delete 级联一起使用，通常会设为<code>all, delete-orphan</code>，因为<code>all</code>包含<code>delete</code>。</li>
<li>因此当<code>cascade</code>参数设为<code>delete-orphan</code>时，它首先包含 delete 级联的行为：当某个 Post 对象被删除时，所有相关的 Comment 对象都将被删除（delete 级联）。除此之外，当某个 Post 对象（父对象）与某个 Comment 对象（子对象）解除关系时，也会删除该 Comment 对象，这个解除关系的对象被称为孤立对象（orphan object）</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    comments = relationship(<span class="string">&#x27;Comment&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post3 = Post()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment5 = Comment()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; comment6 = Comment()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post3.comments.append(comment5)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post3.comments.append(comment6)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(post3)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Post.query.all()</span></span><br><span class="line">[&lt;Post 1&gt;, &lt;Post 3&gt;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Comment.query.all()</span></span><br><span class="line">[&lt;Comment 1&gt;, &lt;Comment 2&gt;, &lt;Comment 5&gt;, &lt;Comment 6&gt;]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post3.comments.remove(comment5)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; post3.comments.remove(comment6)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Comment.query.all()</span></span><br><span class="line">[&lt;Comment 1&gt;, &lt;Comment 2&gt;]</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p><strong>delete</strong>和<strong>delete-orphan</strong>通常会在一对多关系模式中，而且“多”这一侧的对象附属于“一”这一侧的对象时使用。尤其是如果“一”这一侧的“父”对象不存在了，那么“多”这一侧的“子”对象不再有意义的情况。</p>
<p>比如，文章和评论的关系就是一个典型的示例。当文章被删除了，那么评论也就没必要再留存。在这种情况下，如果不使用级联操作，那么我们就需要手动迭代关系另一侧的所有评论对象，然后一一进行删除操作。</p>
</blockquote>

        <h3 id="事件监听"   >
          <a href="#事件监听" class="heading-link"><i class="fas fa-link"></i></a>事件监听</h3>
      <ul>
<li><p>SQLAlchemy 提供了一个<code>listen_for()</code>装饰器，它可以用来注册事件回调函数</p>
</li>
<li><p><code>listen_for()</code>装饰器主要接收两个参数</p>
<ul>
<li><strong>target</strong>表示监听的对象，这个对象可以是模型类、类实例或类属性等</li>
<li><strong>identifier</strong>参数表示被监听事件的标识符，比如，用于监听属性的事件标识符有 set、append、remove、init_scalar、init_collection 等</li>
</ul>
</li>
<li><p>创建了一个 Draft 模型类表示草稿，其中包含 body 字段和 edit_time 字段，分别存储草稿正文和被修改的次数，其中 edit_time 字段的默认值为 0</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Draft</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    edit_time = db.Column(db.Integer, default=<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>

<ul>
<li>通过注册事件监听函数，可以实现在 body 列修改时，自动叠加表示被修改次数的 edit_time 字段。</li>
<li>在 SQLAlchemy 中，每个事件都会有一个对应的事件方法，不同的事件方法支持不同的参数。被注册的监听函数需要接收对应事件方法的所有参数，所以具体的监听函数用法因使用的事件而异</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.event.listens_for(<span class="params">Draft.body, <span class="string">&#x27;set&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_edit_time</span>(<span class="params">target, value, oldvalue, initiator</span>):</span></span><br><span class="line">    <span class="keyword">if</span> target.edit_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        target.edit_time += <span class="number">1</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>其中的 target 参数表示触发事件的模型类实例，使用<code>target.edit_time</code>即可获取需要叠加的字段。其他的参数也需要照常写出，虽然这里没有用到。value 表示被设置的值，oldvalue 表示被取代的旧值。</p>
</blockquote>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft = Draft(body=<span class="string">&#x27;init&#x27;</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.add(draft)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.edit_time</span></span><br><span class="line">0</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.body = <span class="string">&#x27;edited&#x27;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.edit_time</span></span><br><span class="line">1</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.body = <span class="string">&#x27;edited again&#x27;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.edit_time</span></span><br><span class="line">2</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.body = <span class="string">&#x27;edited again again&#x27;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; draft.edit_time</span></span><br><span class="line">3</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; db.session.commit()</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li>另一种方法<ul>
<li>通过在 listen_for（）装饰器中将关键字参数 name 设为 True，可以在监听函数中接收<code>**kwargs</code>作为参数（可变长关键字参数），即“named argument”。</li>
<li>然后在函数中可以使用参数名作为键来从<code>**kwargs</code>字典获取对应的参数值</li>
</ul>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.event.listens_for(<span class="params">Draft.body, <span class="string">&#x27;set&#x27;</span>, named=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_edit_time</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> kwargs[<span class="string">&#x27;target&#x27;</span>].edit_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        kwargs[<span class="string">&#x27;target&#x27;</span>].edit_time += <span class="number">1</span></span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>除了使用<strong>listen_for</strong>装饰器，我们还可以直接使用它内部调用的<code>listen()</code>函数注册事件监听函数时，第三个参数传入被注册的函数对象，比如<code>db.event.listen(SomeClass，&#39;load&#39;，my_load_listener)</code></p>
</blockquote>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://blog.zyuanlee.cn">Pandalzy</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://blog.zyuanlee.cn/2019/08/11/Flask%E5%AD%A6%E4%B9%A005-%E6%95%B0%E6%8D%AE%E5%BA%93/">https://blog.zyuanlee.cn/2019/08/11/Flask%E5%AD%A6%E4%B9%A005-%E6%95%B0%E6%8D%AE%E5%BA%93/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.zyuanlee.cn/tags/Python3/">Python3</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.zyuanlee.cn/tags/Flask%E5%AD%A6%E4%B9%A0/">Flask学习</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2019/08/11/%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">一些操作命令</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/07/28/Flask%E5%AD%A6%E4%B9%A004-%E8%A1%A8%E5%8D%95/"><span class="paginator-prev__text">Flask学习04-表单</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-SQLAlchemy-%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">
          使用 Flask-SQLAlchemy 管理数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.1.</span> <span class="toc-text">
          连接数据库服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">
          定义数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">
          创建数据库和表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">
          数据库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CRUD"><span class="toc-number">2.1.</span> <span class="toc-text">
          CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Create"><span class="toc-number">2.1.1.</span> <span class="toc-text">
          Create</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Read"><span class="toc-number">2.1.2.</span> <span class="toc-text">
          Read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Update"><span class="toc-number">2.1.3.</span> <span class="toc-text">
          Update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delete"><span class="toc-number">2.1.4.</span> <span class="toc-text">
          Delete</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%85%B3%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">
          定义关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">3.1.</span> <span class="toc-text">
          一对多</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%8F%8C%E5%90%91%E5%85%B3%E7%B3%BB"><span class="toc-number">3.1.1.</span> <span class="toc-text">
          建立双向关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-backref-%E7%AE%80%E5%8C%96%E5%85%B3%E7%B3%BB%E5%AE%9A%E4%B9%89"><span class="toc-number">3.1.2.</span> <span class="toc-text">
          使用 backref 简化关系定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80"><span class="toc-number">3.2.</span> <span class="toc-text">
          多对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">3.3.</span> <span class="toc-text">
          一对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">3.4.</span> <span class="toc-text">
          多对多</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-Migrate-%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.</span> <span class="toc-text">
          使用 Flask-Migrate 迁移数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%81%E7%A7%BB%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.</span> <span class="toc-text">
          创建迁移环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%BF%81%E7%A7%BB%E8%84%9A%E6%9C%AC"><span class="toc-number">4.2.</span> <span class="toc-text">
          生成迁移脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.3.</span> <span class="toc-text">
          更新数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6"><span class="toc-number">5.</span> <span class="toc-text">
          进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A7%E8%81%94%E6%93%8D%E4%BD%9C"><span class="toc-number">5.1.</span> <span class="toc-text">
          级联操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#save-update"><span class="toc-number">5.1.1.</span> <span class="toc-text">
          save-update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delete"><span class="toc-number">5.1.2.</span> <span class="toc-text">
          delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delete-orphan"><span class="toc-number">5.1.3.</span> <span class="toc-text">
          delete-orphan</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="toc-number">5.2.</span> <span class="toc-text">
          事件监听</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/assets/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">Stay hungry, stay foolish.</p></div><div class="sidebar-ov-social"></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">45</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">7</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">31</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Pandalzy</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);</script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script><script type="application/json" src="/search.xml"></script></body></html>